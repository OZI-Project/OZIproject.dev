on:
    schedule:
      - cron: '0 0 1 * *'
    workflow_dispatch:
    push:
      paths:
        - .api/*

permissions:
  contents: read

jobs:
    update:
        runs-on: ubuntu-latest
        permissions:
          contents: write
        steps:

            - uses: step-security/harden-runner@ec9f2d5744a09debf3a187a3f4f675c53b671911 # v2.13.0
              with:
                egress-policy: audit

            - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8

            - uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c
              with:
               python-version: '3.12'

            - run: python -m pip install -r .api/requirements.txt

            - name: Update api.json metadata
              run: echo "value=$(ozi -i | jq --compact-output)" >> $GITHUB_OUTPUT
              id: api

            - run: echo $API > api.json
              if: steps.api.outputs.value != ''
              env:
                  API: ${{ steps.api.outputs.value }}

            - name: Commit api.json changes
              continue-on-error: true
              run: |
                git config --global user.name 'OZI-Project'
                git config --global user.email 'OZI-Project@users.noreply.github.com'
                git commit -am "API endpoint updated"
                git push
